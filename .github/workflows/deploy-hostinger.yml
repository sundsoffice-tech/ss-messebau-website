name: Deploy to Hostinger (Git)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: Build and Deploy to Hostinger Branch
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
      
      - name: Determine build output directory
        id: build_dir
        run: |
          echo "ğŸ” Determining build output directory..."
          
          # Check vite.config.ts for build.outDir
          BUILD_DIR=""
          if [ -f "vite.config.ts" ]; then
            # Extract outDir from vite.config.ts if present
            VITE_OUT_DIR=$(grep -Po "outDir:\s*['\"]?\K[^'\"ØŒ]+" vite.config.ts 2>/dev/null | head -1 | tr -d ' ')
            if [ -n "$VITE_OUT_DIR" ]; then
              BUILD_DIR="$VITE_OUT_DIR"
              echo "Found outDir in vite.config.ts: $BUILD_DIR"
            fi
          fi
          
          # Check package.json for build output configuration
          if [ -z "$BUILD_DIR" ] && [ -f "package.json" ]; then
            PKG_OUT_DIR=$(jq -r '.build.outDir // empty' package.json 2>/dev/null)
            if [ -n "$PKG_OUT_DIR" ]; then
              BUILD_DIR="$PKG_OUT_DIR"
              echo "Found outDir in package.json: $BUILD_DIR"
            fi
          fi
          
          # Default to 'dist' if not found
          if [ -z "$BUILD_DIR" ]; then
            BUILD_DIR="dist"
            echo "Using default build directory: $BUILD_DIR"
          fi
          
          # Verify directory exists
          if [ ! -d "$BUILD_DIR" ]; then
            echo "âŒ ERROR: Build directory '$BUILD_DIR' does not exist"
            exit 1
          fi
          
          echo "âœ… Build output directory: $BUILD_DIR"
          echo "build_dir=$BUILD_DIR" >> $GITHUB_OUTPUT
      
      - name: Verify build output
        run: |
          BUILD_DIR="${{ steps.build_dir.outputs.build_dir }}"
          echo "Checking for index.html in $BUILD_DIR/"
          
          if [ ! -f "$BUILD_DIR/index.html" ]; then
            echo "âŒ ERROR: index.html not found in $BUILD_DIR/"
            echo "Build failed - cannot deploy without index.html in root"
            exit 1
          fi
          echo "âœ… index.html found in $BUILD_DIR/"
          
          echo ""
          echo "Build directory contents:"
          ls -lah "$BUILD_DIR/"
          
          echo ""
          echo "Total build size:"
          du -sh "$BUILD_DIR/"
          
          # Check for .htaccess
          if [ -f "$BUILD_DIR/.htaccess" ]; then
            echo "âœ… .htaccess found (SPA routing configured)"
          else
            echo "âš ï¸  Warning: .htaccess not found"
          fi

      - name: Deploy to hostinger branch
        run: |
          BUILD_DIR="${{ steps.build_dir.outputs.build_dir }}"
          echo "ğŸš€ Preparing deployment to hostinger branch..."
          echo "Build directory: $BUILD_DIR"
          
          # Configure git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Create a temporary directory for the hostinger branch
          TEMP_DIR=$(mktemp -d)
          echo "Using temp directory: $TEMP_DIR"
          
          # Copy build files to temp directory
          cp -r "$BUILD_DIR"/* "$TEMP_DIR/"
          cp "$BUILD_DIR"/.htaccess "$TEMP_DIR/" 2>/dev/null || true
          
          # Switch to hostinger branch (create if doesn't exist)
          git fetch origin hostinger:hostinger 2>/dev/null || git checkout --orphan hostinger
          git checkout hostinger || git checkout --orphan hostinger
          
          # Remove all existing files
          git rm -rf . 2>/dev/null || true
          rm -rf ./*
          
          # Copy build files from temp directory
          cp -r "$TEMP_DIR"/* .
          cp "$TEMP_DIR"/.htaccess . 2>/dev/null || true
          
          # Add all files
          git add -A
          
          # Commit changes
          COMMIT_MSG="Deploy from main @ $(git rev-parse --short main) - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          git commit -m "$COMMIT_MSG" || echo "No changes to commit"
          
          # Push to hostinger branch
          git push -f origin hostinger
          
          echo "âœ… Deployment to hostinger branch completed!"
          echo "ğŸ“¦ Branch 'hostinger' now contains the production-ready website"
          echo "ğŸ”— Configure Hostinger to deploy from branch 'hostinger'"

      - name: Deployment Summary
        if: success()
        run: |
          BUILD_DIR="${{ steps.build_dir.outputs.build_dir }}"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "   â€¢ Source Branch: main"
          echo "   â€¢ Target Branch: hostinger"
          echo "   â€¢ Build Output: $BUILD_DIR/ â†’ hostinger branch root"
          echo "   â€¢ index.html: âœ… Available in branch root"
          echo "   â€¢ .htaccess: âœ… Configured for SPA routing"
          echo ""
          echo "ğŸ”§ Hostinger Git Configuration:"
          echo "   â€¢ Repository: sundsoffice-tech/ss-messebau-website"
          echo "   â€¢ Branch: hostinger"
          echo "   â€¢ Deploy Path: public_html (oder leer lassen)"
          echo "   â€¢ Auto-Deploy: Aktiviert"
          echo ""
          echo "ğŸŒ The website is ready to be deployed by Hostinger!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
