# NOTE: This workflow is now OPTIONAL since the auto-build.yml workflow
# commits the dist/ folder directly to the main branch.
# Hostinger can deploy directly from the main branch instead of using this separate hostinger branch.
# This workflow is kept as a backup deployment option.
name: Deploy to Hostinger (Git)

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    name: Build and Deploy to Hostinger Branch
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: npm

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build
      
      - name: Verify build output
        run: |
          echo "Checking for index.html in dist/"
          if [ ! -f "dist/index.html" ]; then
            echo "âŒ ERROR: index.html not found in dist/"
            echo "Build failed - cannot deploy without index.html"
            exit 1
          fi

          if ! grep -q '<div id="root">' dist/index.html; then
            echo "âŒ ERROR: root mount element missing in dist/index.html"
            exit 1
          fi

          if [ ! -f "dist/.htaccess" ]; then
            echo "âŒ ERROR: .htaccess not found in dist/ (Hostinger SPA routing would break)"
            exit 1
          fi

          echo "âœ… index.html, #root mount point und .htaccess sind vorhanden"

          echo ""
          echo "Build directory contents:"
          ls -lah dist/

          echo ""
          echo "Total build size:"
          du -sh dist/

      - name: Deploy to hostinger branch
        run: |
          echo "ğŸš€ Preparing deployment to hostinger branch..."
          
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # Build-Output sichern
          TEMP_DIR=$(mktemp -d)
          echo "Using temp directory: $TEMP_DIR"
          
          cp -a dist/* "$TEMP_DIR/"
          cp -a dist/.htaccess "$TEMP_DIR/" 2>/dev/null || true
          
          COMMIT_SHA=$(git rev-parse --short HEAD)
          
          # Bestehenden hostinger Branch auschecken (oder neu erstellen)
          echo "Fetching hostinger branch..."
          git fetch origin hostinger || true
          
          # Remove dist/ to prevent git conflict when switching branches
          echo "Cleaning dist/ directory before branch switch..."
          git rm -rf dist/ 2>/dev/null || true
          rm -rf dist/
          
          if git rev-parse --verify origin/hostinger >/dev/null 2>&1; then
            echo "âœ“ Hostinger branch exists, checking out..."
            git checkout hostinger
            git pull origin hostinger || true
          else
            echo "âœ“ Creating new hostinger branch..."
            git checkout --orphan hostinger
            git rm -rf . 2>/dev/null || true
          fi
          
          # Alte Dateien entfernen
          echo "Cleaning old files..."
          git rm -rf . 2>/dev/null || true
          rm -rf node_modules/ dist/ .gitignore 2>/dev/null || true
          
          # Neue Build-Dateien kopieren
          echo "Copying new build files..."
          cp -a "$TEMP_DIR"/* .
          cp -a "$TEMP_DIR"/.htaccess . 2>/dev/null || true
          
          # Normal committen und pushen (KEIN --force!)
          git add -A
          
          COMMIT_MSG="Deploy from main @ ${COMMIT_SHA} - $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "$COMMIT_MSG"
            git push origin hostinger
            echo "âœ… Deployment to hostinger branch completed!"
          fi

      - name: Deployment Summary
        if: success()
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "âœ… DEPLOYMENT SUCCESSFUL"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "ğŸ“‹ Deployment Details:"
          echo "   â€¢ Source Branch: main"
          echo "   â€¢ Target Branch: hostinger"
          echo "   â€¢ Build Output: dist/ â†’ hostinger branch root"
          echo ""
          echo "ğŸŒ The website will be deployed by Hostinger automatically!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
