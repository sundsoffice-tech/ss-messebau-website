# ğŸ”´ Admin Dashboard: localStorage-Module auf PHP-Backend (SQLite) migrieren

## Zusammenfassung

5 von 9 Admin-Dashboard-Modulen speichern Daten ausschlieÃŸlich im `localStorage` des Browsers (`window.spark.kv` â†’ `spark_kv_*`-Prefix). Diese Daten gehen verloren bei Browser-Wechsel, Cache-Leerung oder Device-Wechsel. AuÃŸerdem werden sensible API-Keys (SendGrid, AI-Provider) im Frontend exponiert.

**Ziel:** Alle localStorage-basierten Services auf das bestehende PHP-Backend (`public/api/`) mit SQLite-Datenbank migrieren â€“ analog zu den bereits funktionierenden Modulen (`auth.php`, `orders.php`, `inquiries.php`, `email.php`).

---

## Ist-Zustand: Architektur-Ãœbersicht

```
Frontend (Browser)
â”œâ”€â”€ âœ… auth.php â”€â”€â”€â”€â”€â”€â”€â”€ Login/Logout/Setup (PHP Sessions + SQLite)    â†’ FUNKTIONIERT
â”œâ”€â”€ âœ… orders.php â”€â”€â”€â”€â”€â”€ Bestellungen CRUD (SQLite)                    â†’ FUNKTIONIERT
â”œâ”€â”€ âœ… inquiries.php â”€â”€â”€ Anfragen CRUD (SQLite)                        â†’ FUNKTIONIERT
â”œâ”€â”€ âœ… email.php â”€â”€â”€â”€â”€â”€â”€ E-Mail Queue + Versand (SQLite + SendGrid)    â†’ FUNKTIONIERT
â”‚
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ Blog-Posts (admin_blog_posts)                  â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ Messe-Events (admin_messe_events)              â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ Ext. API Keys (admin_api_keys)                 â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ SMTP-Config (smtp_config)                      â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ Notification-Config (notification_config)      â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ AI Keys (ai_api_keys)                          â†’ MIGRATION NÃ–TIG
â”œâ”€â”€ âŒ localStorage â”€â”€â”€â”€ AI Training Data (ai_training_data)            â†’ MIGRATION NÃ–TIG
â””â”€â”€ âŒ localStorage â”€â”€â”€â”€ AI Audit Log (ai_audit_log)                    â†’ MIGRATION NÃ–TIG
```

---

## Detaillierte Analyse pro Modul

### 1. ğŸ“ Blog Manager

**Betroffene Dateien:**
- Frontend: `src/lib/admin-content-service.ts` (Zeile 110-143) â€“ `getBlogPosts()`, `addBlogPost()`, `updateBlogPost()`, `deleteBlogPost()`
- Komponente: Blog-Manager in `src/components/AdminContentPanels.tsx`

**localStorage-Key:** `spark_kv_admin_blog_posts`

**Datenstruktur:**
```typescript
interface AdminBlogPost {
  id: string
  title: string
  slug: string
  category: string    // 'messebau' | 'messen' | 'nachhaltigkeit' | 'service' | 'branchen' | 'sonstiges'
  imageUrl: string
  excerpt: string
  content: string
  publishedAt: number
  createdAt: number
  updatedAt: number
}
```

**BenÃ¶tigtes PHP-Backend:**
- `public/api/blog.php` â€“ CRUD-Endpoints (GET list, GET single, POST, PATCH, DELETE)
- DB-Tabelle `blog_posts` in `db.php` â†’ `initSchema()`
- GET erfordert **keine** Auth (Ã¶ffentliche Blog-Seite), POST/PATCH/DELETE erfordern Auth

---

### 2. ğŸ“… Messe Manager

**Betroffene Dateien:**
- Frontend: `src/lib/admin-content-service.ts` (Zeile 147-178) â€“ `getMesseEvents()`, `addMesseEvent()`, `updateMesseEvent()`, `deleteMesseEvent()`
- Komponente: Messe-Manager in `src/components/AdminContentPanels.tsx`

**localStorage-Key:** `spark_kv_admin_messe_events`

**Datenstruktur:**
```typescript
interface AdminMesseEvent {
  id: string
  name: string
  location: string
  startDate: string
  endDate: string
  category: 'food' | 'industrie' | 'versicherungen' | 'allgemein'
  website: string
  description: string
  ssPresent: boolean
  imageUrl: string
  createdAt: number
  updatedAt: number
}
```

**BenÃ¶tigtes PHP-Backend:**
- `public/api/messen.php` â€“ CRUD-Endpoints
- DB-Tabelle `messe_events` in `db.php` â†’ `initSchema()`
- GET erfordert **keine** Auth (Ã¶ffentliche Messe-Seite), POST/PATCH/DELETE erfordern Auth

---

### 3. ğŸ”‘ Externe API Keys

**Betroffene Dateien:**
- Frontend: `src/lib/admin-content-service.ts` (Zeile 182-218) â€“ `getApiKeys()`, `addApiKey()`, `updateApiKey()`, `deleteApiKey()`
- Komponente: API-Key-Manager in `src/components/AdminContentPanels.tsx`

**localStorage-Key:** `spark_kv_admin_api_keys`

**Kritisches Problem:**
```typescript
// Zeile 186-198: Der echte Key wird SOFORT verworfen â€“ nur die Maske wird gespeichert!
export function addApiKey(serviceName: string, key: string, description: string): AdminApiKey {
  const newKey: AdminApiKey = {
    maskedKey: maskKey(key),   // â† Nur letzte 4 Zeichen behalten
  }
}
```
Der echte API-Key wird nie persistiert und kann daher nie verwendet werden.

**BenÃ¶tigtes PHP-Backend:**
- `public/api/apikeys.php` â€“ CRUD-Endpoints
- DB-Tabelle `external_api_keys` in `db.php`
- **Key muss serverseitig verschlÃ¼sselt gespeichert werden** (AES-256 oder Ã¤hnlich)
- Alle Endpoints erfordern Auth
- GET gibt nur `maskedKey` zurÃ¼ck, nie den echten Key

---

### 4. âš™ï¸ SMTP-Konfiguration

**Betroffene Dateien:**
- Frontend: `src/lib/smtp-service.ts` (Zeile 32-44) â€“ `getEmailConfig()`, `saveEmailConfig()`
- Komponente: `src/components/SMTPConfigPanel.tsx` (Zeile 49-58)

**localStorage-Key:** `spark_kv_smtp_config`

**ğŸ”´ Kritisches Sicherheitsproblem:**
```typescript
// smtp-service.ts Zeile 89-96: SendGrid-Key wird direkt vom Browser an die SendGrid-API gesendet!
const response = await fetch('https://api.sendgrid.com/v3/mail/send', {
  headers: {
    'Authorization': `Bearer ${config.apiKey}`,  // â† API-Key im Frontend exponiert!
  },
})
```

**Hinweis:** Das Backend `email.php` liest den SendGrid-Key bereits aus `config.php` (serverseitig):
```php
// config.php Zeile 11:
define('SENDGRID_API_KEY', getenv('SENDGRID_API_KEY') ?: '');
```
Es gibt also **zwei parallele Systeme** â€“ `smtp-service.ts` (Frontend, unsicher) und `email.php` (Backend, sicher).

**LÃ¶sung:**
- SMTP-Config via `email.php?action=config` serverseitig speichern/laden
- `smtp-service.ts` â†’ `sendViaSendGrid()` / `sendViaSES()` komplett durch Backend-Versand ersetzen
- Frontend soll nur noch die Config-UI bereitstellen, **nie** direkt mit SendGrid/SES kommunizieren

---

### 5. ğŸ”” Benachrichtigungen (Notification Config)

**Betroffene Dateien:**
- Frontend: `src/lib/notification-service.ts` (Zeile 40-51) â€“ `getNotificationConfig()`, `saveNotificationConfig()`
- Komponente: `src/components/NotificationConfigPanel.tsx`

**localStorage-Key:** `spark_kv_notification_config`

**Datenstruktur:**
```typescript
interface NotificationConfig {
  recipients: string[]           // E-Mail-EmpfÃ¤nger
  webhooks: WebhookConfig[]      // Slack/Teams Webhooks
  sendCustomerConfirmation: boolean
}
interface WebhookConfig {
  url: string
  enabled: boolean
  channel: string
  types: ('inquiry' | 'kontakt' | 'banner')[ ]
}
```

**Probleme:**
1. Config nur im Browser des Admins â€“ anderer Admin sieht andere Config
2. Webhook-Versand geht direkt vom Browser (CORS-Probleme)
3. `sendFormNotification()` (Zeile 213-257) ruft `sendEmail()` aus `smtp-service.ts` auf â†’ SendGrid-Key im Frontend

**BenÃ¶tigtes PHP-Backend:**
- `public/api/notifications.php` â€“ Config lesen/speichern + Webhook-Versand serverseitig
- DB-Tabelle `notification_config` in `db.php`
- Webhook-Versand via PHP (`curl`) statt Browser-Fetch

---

### 6. ğŸ¤– KI-Chatbot Admin (AI Admin Service)

**Betroffene Dateien:**
- Frontend: `src/lib/ai-admin-service.ts` â€“ Alle CRUD-Funktionen
- Komponente: `src/components/AIAdminPanel.tsx`
- Chat-Service: `src/lib/chat-service.ts` (Zeile 142) â€“ ruft `window.spark.llm()` auf

**localStorage-Keys:**
- `spark_kv_ai_api_keys` â€“ AI Provider Keys
- `spark_kv_ai_training_data` â€“ Wissensdateien fÃ¼r den Chatbot
- `spark_kv_ai_audit_log` â€“ Audit-Log

**ğŸ”´ Kritisches Problem â€“ `window.spark.llm` ist ein Stub:**
```typescript
// chat-service.ts Zeile 142:
const response = await window.spark.llm(fullPrompt, 'gpt-4o', false)
```
`window.spark.llm` ist eine Spark-Platform-Funktion, die auf einem eigenstÃ¤ndigen Server nicht existiert. Der im Admin-Dashboard eingegebene API-Key wird in `addAIKey()` zwar gespeichert, aber:
1. Nur die Maske wird behalten (Zeile 98: `maskedKey: maskKey(key)`)
2. Der echte Key wird als `{ encrypted: true, provider }` gespeichert â€“ **ohne den eigentlichen Key!** (Zeile 108)
3. `chat-service.ts` liest den Key nirgendwo aus und Ã¼bergibt ihn nicht an `window.spark.llm()`

**BenÃ¶tigtes PHP-Backend:**
- `public/api/ai.php` â€“ Endpoints fÃ¼r:
  - `?action=keys` â€“ AI-Key CRUD (Keys serverseitig verschlÃ¼sselt speichern)
  - `?action=training` â€“ Training Data CRUD
  - `?action=audit` â€“ Audit Log lesen/schreiben
  - `?action=chat` â€“ **Proxy-Endpoint** der den LLM-Call serverseitig macht (OpenAI/Anthropic/Google API) mit dem serverseitig gespeicherten Key
- DB-Tabellen: `ai_keys`, `ai_training_data`, `ai_audit_log`
- `chat-service.ts` muss refactored werden: statt `window.spark.llm()` â†’ `fetch('/api/ai.php?action=chat', ...)`

---

## Implementierungsplan

### Phase 1: Neue DB-Tabellen (in `db.php` â†’ `initSchema()`)

```sql
CREATE TABLE IF NOT EXISTS blog_posts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  slug TEXT UNIQUE NOT NULL,
  title TEXT NOT NULL,
  category TEXT DEFAULT 'sonstiges',
  image_url TEXT,
  excerpt TEXT,
  content TEXT NOT NULL,
  published_at TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS messe_events (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  name TEXT NOT NULL,
  location TEXT,
  start_date TEXT,
  end_date TEXT,
  category TEXT DEFAULT 'allgemein',
  website TEXT,
  description TEXT,
  ss_present INTEGER DEFAULT 0,
  image_url TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS external_api_keys (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  service_name TEXT NOT NULL,
  encrypted_key TEXT NOT NULL,
  masked_key TEXT NOT NULL,
  description TEXT,
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS notification_config (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  config_key TEXT UNIQUE NOT NULL,
  config_value TEXT NOT NULL,
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS ai_keys (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  provider TEXT NOT NULL,
  encrypted_key TEXT NOT NULL,
  masked_key TEXT NOT NULL,
  status TEXT DEFAULT 'active',
  last_used_at TEXT,
  created_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS ai_training_data (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  title TEXT NOT NULL,
  content TEXT NOT NULL,
  category TEXT DEFAULT 'faq',
  active INTEGER DEFAULT 1,
  created_by TEXT DEFAULT 'admin',
  created_at TEXT DEFAULT (datetime('now')),
  updated_at TEXT DEFAULT (datetime('now'))
);

CREATE TABLE IF NOT EXISTS ai_audit_log (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  action TEXT NOT NULL,
  actor TEXT DEFAULT 'admin',
  details TEXT,
  category TEXT DEFAULT 'config',
  created_at TEXT DEFAULT (datetime('now'))
);
```

### Phase 2: Neue PHP-API-Dateien

| Datei | Endpoints | Auth |
|-------|-----------|------|
| `blog.php` | GET list, GET single (by slug), POST, PATCH, DELETE | GET: public, Rest: auth |
| `messen.php` | GET list, POST, PATCH, DELETE | GET: public, Rest: auth |
| `apikeys.php` | GET list (masked), POST, DELETE | Alle: auth |
| `notifications.php` | GET config, POST config, POST webhook-test | Alle: auth |
| `ai.php` | GET keys, POST key, DELETE key, GET training, POST training, PATCH training, DELETE training, GET audit, POST chat | Alle: auth |

### Phase 3: Frontend-Services refactoren

| Service-Datei | Ã„nderung |
|--------------|----------|
| `admin-content-service.ts` | `localStorage` â†’ `apiFetch()` calls zu `blog.php` / `messen.php` / `apikeys.php` |
| `smtp-service.ts` | `window.spark.kv` â†’ `apiFetch()` zu `email.php?action=config`; `sendViaSendGrid()` / `sendViaSES()` entfernen â†’ Backend-Versand |
| `notification-service.ts` | `window.spark.kv` â†’ `apiFetch()` zu `notifications.php`; Webhook-Versand an Backend delegieren |
| `ai-admin-service.ts` | `localStorage` â†’ `apiFetch()` zu `ai.php` |
| `chat-service.ts` | `window.spark.llm()` â†’ `apiFetch('/api/ai.php?action=chat', ...)` |

### Phase 4: Komponenten anpassen

| Komponente | Ã„nderung |
|-----------|----------|
| `AdminContentPanels.tsx` | Synchrone localStorage-Calls â†’ async API-Calls mit Loading-States |
| `SMTPConfigPanel.tsx` | `window.spark.kv.get('smtp_config')` â†’ API-Call |
| `NotificationConfigPanel.tsx` | `getNotificationConfig()` â†’ API-Call |
| `AIAdminPanel.tsx` | Alle `getAIKeys()`, `getTrainingData()` etc. â†’ async API-Calls |

---

## Sicherheitsanforderungen

1. **API-Keys niemals im Frontend speichern oder exponieren** â€“ SendGrid, AWS SES, OpenAI Keys â†’ nur serverseitig in `config.php` (Env-Variablen) oder verschlÃ¼sselt in SQLite. Frontend zeigt nur maskierte Keys an.
2. **Alle Admin-Endpoints mit `requireAuth()` schÃ¼tzen** â€“ Ausnahme: Blog/Messe GET-Endpoints (Ã¶ffentlich)
3. **LLM-Calls nur serverseitig** â€“ `ai.php?action=chat` macht den API-Call zu OpenAI/Anthropic. Frontend sendet nur die Nutzerfrage + Kontext.
4. **Webhook-Versand serverseitig** â€“ `notifications.php?action=send_webhook` via PHP curl â€“ kein CORS-Problem mehr.

---

## Akzeptanzkriterien

- [ ] Alle 8 localStorage-Keys (`admin_blog_posts`, `admin_messe_events`, `admin_api_keys`, `smtp_config`, `notification_config`, `ai_api_keys`, `ai_training_data`, `ai_audit_log`) werden nicht mehr verwendet
- [ ] Blog-Posts und Messe-Events sind auf der Ã¶ffentlichen Webseite sichtbar (via API)
- [ ] SMTP-Config wird serverseitig gespeichert und der SendGrid-Key wird nie an den Browser gesendet
- [ ] KI-Chatbot funktioniert Ende-zu-Ende: Admin gibt Key ein â†’ Key wird serverseitig gespeichert â†’ Chat-Anfrage geht an Backend â†’ Backend ruft OpenAI API auf â†’ Antwort wird zurÃ¼ckgegeben
- [ ] Training Data wird vom Chat-Backend gelesen und als Kontext an den LLM-Prompt angehÃ¤ngt
- [ ] Webhooks (Slack/Teams) werden serverseitig versendet
- [ ] Alle Admin-Endpoints erfordern Authentifizierung
- [ ] Bestehende Frontend-FunktionalitÃ¤t (UI, UX, Validierung) bleibt erhalten
- [ ] `window.spark.kv` und `window.spark.llm` werden nicht mehr aufgerufen
