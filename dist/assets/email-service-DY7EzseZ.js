const e={provider:"test",fromEmail:"noreply@sunds-messebau.de",fromName:"S&S Messebau GbR"};async function n(){try{return await window.spark.kv.get("smtp_config")||e}catch{return e}}async function t(e){const t={...await n(),...e};await window.spark.kv.set("smtp_config",t)}function a(e){return e.to,e.subject,e.from,e.replyTo&&e.replyTo,e.attachments&&e.attachments.length>0&&e.attachments.map(e=>`${e.name} (${function(e){if(0===e)return"0 Bytes";const n=1024,t=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(n));return Math.round(e/Math.pow(n,a)*100)/100+" "+t[a]}(e.size)})`).join(", "),e.htmlBody.substring(0,200),!0}async function i(e){try{const t=await n();switch(t.provider){case"sendgrid":await async function(e,n){if(!n.apiKey)throw new Error("SendGrid API Key nicht konfiguriert");const t=e.attachments?.map(e=>({content:e.dataUrl.split(",")[1],filename:e.name,type:e.type,disposition:"attachment"}))||[],a={personalizations:[{to:[{email:e.to}],subject:e.subject}],from:{email:e.from||n.fromEmail,name:n.fromName},reply_to:e.replyTo?{email:e.replyTo}:void 0,content:[{type:"text/plain",value:e.textBody},{type:"text/html",value:e.htmlBody}],attachments:t.length>0?t:void 0},i=await fetch("https://api.sendgrid.com/v3/mail/send",{method:"POST",headers:{Authorization:`Bearer ${n.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(a)});if(!i.ok){const e=await i.text();throw new Error(`SendGrid API Fehler: ${i.status} - ${e}`)}return!0}(e,t);break;case"ses":await async function(e,n){if(!n.apiKey)throw new Error("AWS SES Credentials nicht konfiguriert");const t=`----=_Part_${Date.now()}_${Math.random().toString(36).substring(2)}`;let a=`From: ${n.fromName} <${e.from||n.fromEmail}>\n`;if(a+=`To: ${e.to}\n`,e.replyTo&&(a+=`Reply-To: ${e.replyTo}\n`),a+=`Subject: ${e.subject}\n`,a+="MIME-Version: 1.0\n",a+=`Content-Type: multipart/mixed; boundary="${t}"\n\n`,a+=`--${t}\n`,a+=`Content-Type: multipart/alternative; boundary="${t}_alt"\n\n`,a+=`--${t}_alt\n`,a+="Content-Type: text/plain; charset=UTF-8\n\n",a+=`${e.textBody}\n\n`,a+=`--${t}_alt\n`,a+="Content-Type: text/html; charset=UTF-8\n\n",a+=`${e.htmlBody}\n\n`,a+=`--${t}_alt--\n\n`,e.attachments&&e.attachments.length>0)for(const o of e.attachments){const e=o.dataUrl.split(",")[1];a+=`--${t}\n`,a+=`Content-Type: ${o.type}; name="${o.name}"\n`,a+=`Content-Disposition: attachment; filename="${o.name}"\n`,a+="Content-Transfer-Encoding: base64\n\n",a+=`${e}\n\n`}a+=`--${t}--`;const i=btoa(unescape(encodeURIComponent(a))),s=`https://email.${n.region||"eu-central-1"}.amazonaws.com/`,r={Action:"SendRawEmail","RawMessage.Data":i},l=await fetch(s,{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded"},body:new URLSearchParams(r).toString()});if(!l.ok){const e=await l.text();throw new Error(`AWS SES API Fehler: ${l.status} - ${e}`)}return!0}(e,t);break;default:a(e)}return{success:!0}}catch(t){const e=t instanceof Error?t.message:"Unbekannter Fehler";return console.error("‚ùå E-Mail-Versand fehlgeschlagen:",e),{success:!1,error:e}}}async function s(){try{const e=await n();if("test"===e.provider)return{success:!0,message:"Test-Modus aktiv. E-Mails werden simuliert (keine echten E-Mails versendet)."};const t={to:"test@sunds-messebau.de",subject:"Test-E-Mail von S&S Messebau",htmlBody:"<html><body><h1>Test erfolgreich!</h1><p>Die E-Mail-Konfiguration funktioniert.</p></body></html>",textBody:"Test erfolgreich! Die E-Mail-Konfiguration funktioniert."},a=await i(t);return a.success?{success:!0,message:`Verbindung zu ${e.provider.toUpperCase()} erfolgreich getestet.`}:{success:!1,message:a.error||"Verbindungstest fehlgeschlagen."}}catch(e){return{success:!1,message:e instanceof Error?e.message:"Verbindungstest fehlgeschlagen."}}}async function r(){const e=await n(),t="test"===e.provider,a=!!e.apiKey;return{provider:e.provider,configured:t||a,ready:t||a,testMode:t}}function l(e){const{step1:n,step2:t,step3:a,step4:i,step5:s,step6:r}=e;return`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 800px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #3B4CC0 0%, #2A3A9F 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }\n    .section { background: #f9f9f9; padding: 20px; margin: 20px 0; border-radius: 8px; border-left: 4px solid #3B4CC0; }\n    .section h2 { color: #3B4CC0; margin-top: 0; font-size: 18px; }\n    .row { display: flex; margin: 10px 0; }\n    .label { font-weight: bold; min-width: 200px; color: #555; }\n    .value { color: #333; }\n    .footer { background: #333; color: white; padding: 20px; text-align: center; border-radius: 0 0 8px 8px; margin-top: 20px; }\n    .badge { display: inline-block; background: #4CAF50; color: white; padding: 4px 12px; border-radius: 12px; font-size: 12px; margin-left: 10px; }\n    .files { background: #e8f5e9; padding: 15px; border-radius: 6px; margin-top: 10px; }\n    .file-item { padding: 8px; background: white; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="header">\n      <h1 style="margin: 0;">üéØ Neue Banner-Bestellung</h1>\n      <p style="margin: 10px 0 0 0; opacity: 0.9;">S&S Messebau GbR</p>\n    </div>\n\n    <div class="section">\n      <h2>üìã Kunde & Kontakt</h2>\n      <div class="row">\n        <div class="label">Firma:</div>\n        <div class="value">${r.firmaKontakt}</div>\n      </div>\n      <div class="row">\n        <div class="label">Ansprechpartner:</div>\n        <div class="value">${r.ansprechpartner}</div>\n      </div>\n      <div class="row">\n        <div class="label">E-Mail:</div>\n        <div class="value"><a href="mailto:${r.email}">${r.email}</a></div>\n      </div>\n      <div class="row">\n        <div class="label">Telefon:</div>\n        <div class="value"><a href="tel:${r.telefon}">${r.telefon}</a></div>\n      </div>\n      ${r.ustId?`\n      <div class="row">\n        <div class="label">USt-ID:</div>\n        <div class="value">${r.ustId}</div>\n      </div>`:""}\n    </div>\n\n    <div class="section">\n      <h2>üì¶ Bestellung - Einsatz & System</h2>\n      <div class="row">\n        <div class="label">Einsatzort:</div>\n        <div class="value">${n.einsatzort}</div>\n      </div>\n      <div class="row">\n        <div class="label">Rahmenart:</div>\n        <div class="value">${o(n.rahmenart)}</div>\n      </div>\n      <div class="row">\n        <div class="label">Menge:</div>\n        <div class="value">${n.menge} St√ºck</div>\n      </div>\n      <div class="row">\n        <div class="label">Indoor/Outdoor:</div>\n        <div class="value">${"indoor"===n.indoorOutdoor?"üè¢ Indoor":"üå§Ô∏è Outdoor"}</div>\n      </div>\n      ${n.montage?`\n      <div class="row">\n        <div class="label">Montage:</div>\n        <div class="value">‚úÖ Ja ${n.montageOrt?`- Ort: ${n.montageOrt}`:""} ${n.montageZeitraum?`(${n.montageZeitraum})`:""}</div>\n      </div>`:""}\n    </div>\n\n    <div class="section">\n      <h2>üìê Ma√üe & Ausf√ºhrung</h2>\n      <div class="row">\n        <div class="label">Abmessungen:</div>\n        <div class="value"><strong>${t.breite} √ó ${t.hoehe} mm</strong></div>\n      </div>\n      <div class="row">\n        <div class="label">Profil:</div>\n        <div class="value">${c=t.profil,{standard:"Standard",premium:"Premium",sonder:"Sonder"}[c]||c}</div>\n      </div>\n      <div class="row">\n        <div class="label">Ecken:</div>\n        <div class="value">${"gehrung"===t.ecken?"Gehrung":"Verbinder"}</div>\n      </div>\n      <div class="row">\n        <div class="label">Seitigkeit:</div>\n        <div class="value">${"einseitig"===t.seitigkeit?"Einseitig":"Zweiseitig"}</div>\n      </div>\n      ${t.led?`\n      <div class="row">\n        <div class="label">LED/Backlit:</div>\n        <div class="value">üí° Ja ${t.ledStrom?`- ${t.ledStrom}`:""} ${t.ledEinsatz?`(${t.ledEinsatz})`:""}</div>\n      </div>`:""}\n    </div>\n\n    <div class="section">\n      <h2>üñ®Ô∏è Banner & Druck</h2>\n      ${a.bannerBenoetigt?`\n      <div class="row">\n        <div class="label">Banner ben√∂tigt:</div>\n        <div class="value">‚úÖ Ja</div>\n      </div>\n      ${a.material?`\n      <div class="row">\n        <div class="label">Material:</div>\n        <div class="value">${d=a.material,{frontlit:"Frontlit (Standard)",blockout:"Blockout",backlit:"Backlit"}[d]||d}</div>\n      </div>`:""}\n      ${a.konfektion&&a.konfektion.length>0?`\n      <div class="row">\n        <div class="label">Konfektion:</div>\n        <div class="value">${a.konfektion.join(", ")}</div>\n      </div>`:""}\n      ${a.brandschutz?'\n      <div class="row">\n        <div class="label">Brandschutz:</div>\n        <div class="value"><span class="badge">B1 zertifiziert</span></div>\n      </div>':""}\n      ${a.druckqualitaet?`\n      <div class="row">\n        <div class="label">Druckqualit√§t:</div>\n        <div class="value">${"high"===a.druckqualitaet?"High Quality":"Standard"}</div>\n      </div>`:""}\n      `:'\n      <div class="row">\n        <div class="label">Banner ben√∂tigt:</div>\n        <div class="value">‚ùå Nein</div>\n      </div>\n      '}\n    </div>\n\n    <div class="section">\n      <h2>üìÅ Druckdaten & Upload</h2>\n      ${i.druckdatenVorhanden?`\n      <div class="row">\n        <div class="label">Druckdaten:</div>\n        <div class="value">‚úÖ Vorhanden</div>\n      </div>\n      ${i.serializedFiles&&i.serializedFiles.length>0?`\n      <div class="files">\n        <strong>Hochgeladene Dateien (${i.serializedFiles.length}):</strong>\n        ${i.serializedFiles.map(e=>`\n          <div class="file-item">\n            üìé <strong>${e.name}</strong> - ${function(e){if(0===e)return"0 Bytes";const n=1024,t=["Bytes","KB","MB","GB"],a=Math.floor(Math.log(e)/Math.log(n));return Math.round(e/Math.pow(n,a)*100)/100+" "+t[a]}(e.size)}\n            <br><small style="color: #666;">Typ: ${e.type}</small>\n          </div>\n        `).join("")}\n      </div>\n      `:'<p style="color: #666; margin-top: 10px;">‚ÑπÔ∏è Keine Dateien hochgeladen</p>'}\n      `:`\n      <div class="row">\n        <div class="label">Druckdaten:</div>\n        <div class="value">‚ùå Noch nicht vorhanden</div>\n      </div>\n      ${i.grafikservice?`\n      <div class="row">\n        <div class="label">Grafikservice:</div>\n        <div class="value">‚úÖ Gew√ºnscht</div>\n      </div>\n      ${i.designwunsch?`\n      <div class="row">\n        <div class="label">Designwunsch:</div>\n        <div class="value">${i.designwunsch}</div>\n      </div>`:""}\n      `:""}\n      `}\n      ${i.kommentar?`\n      <div class="row">\n        <div class="label">Kommentar:</div>\n        <div class="value" style="white-space: pre-wrap;">${i.kommentar}</div>\n      </div>`:""}\n    </div>\n\n    <div class="section">\n      <h2>üöö Lieferung & Termin</h2>\n      <div class="row">\n        <div class="label">Lieferadresse:</div>\n        <div class="value">\n          ${s.firma}<br>\n          ${s.strasse}<br>\n          ${s.plz} ${s.ort}<br>\n          ${s.land}\n        </div>\n      </div>\n      ${s.wunschDatum?`\n      <div class="row">\n        <div class="label">Wunschlieferdatum:</div>\n        <div class="value">üìÖ ${new Date(s.wunschDatum).toLocaleDateString("de-DE")}</div>\n      </div>`:""}\n      <div class="row">\n        <div class="label">Lieferart:</div>\n        <div class="value">${l=s.lieferart,{spedition:"üöõ Spedition",abholung:"üè™ Abholung",kurier:"üèÉ Kurier"}[l]||l} ${s.express?'<span class="badge">EXPRESS</span>':""}</div>\n      </div>\n      ${s.zeitfenster?`\n      <div class="row">\n        <div class="label">Zeitfenster:</div>\n        <div class="value">${s.zeitfenster}</div>\n      </div>`:""}\n    </div>\n\n    <div class="footer">\n      <p style="margin: 0 0 10px 0;"><strong>S&S Messebau GbR</strong></p>\n      <p style="margin: 0; font-size: 14px; opacity: 0.9;">\n        Bonnenbroicherstra√üe 93 | 41238 M√∂nchengladbach<br>\n        Tel: +49 176 31570041<br>\n        E-Mail: sunds-messebau@gmx.de\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n  `.trim();var l,d,c}function o(e){return{haengerahmen:"H√§ngerahmen",standrahmen:"Standrahmen",verkleidungsrahmen:"Verkleidungsrahmen"}[e]||e}async function d(e){try{const n=await window.spark.kv.get(e);if(!n)return{success:!1,error:"E-Mail nicht in Queue gefunden"};const t=await i({to:n.to,subject:n.subject,htmlBody:n.htmlBody,textBody:n.textBody,attachments:n.attachments});if(!t.success)return{success:!1,error:`Firmen-E-Mail: ${t.error}`};const a=await i({to:n.customerEmail,subject:n.customerSubject,htmlBody:n.customerHtmlBody,textBody:n.customerTextBody});return a.success?(n.sent=!0,n.sentAt=(new Date).toISOString(),await window.spark.kv.set(e,n),{success:!0}):{success:!1,error:`Kunden-E-Mail: ${a.error}`}}catch(n){console.error("‚ùå Fehler beim Versenden der E-Mail:",n);return{success:!1,error:n instanceof Error?n.message:"Unbekannter Fehler"}}}function c(e){return e.replace(/<style[^>]*>[\s\S]*?<\/style>/gi,"").replace(/<script[^>]*>[\s\S]*?<\/script>/gi,"").replace(/<br\s*\/?>/gi,"\n").replace(/<\/div>/gi,"\n").replace(/<\/p>/gi,"\n\n").replace(/<\/h[1-6]>/gi,"\n\n").replace(/<[^>]+>/g,"").replace(/&nbsp;/g," ").replace(/&amp;/g,"&").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/\n\s*\n\s*\n/g,"\n\n").trim()}const u=Object.freeze(Object.defineProperty({__proto__:null,sendOrderConfirmationEmail:async function(e){try{const{config:n,configId:t,sendImmediately:a=!1}=e,i=`Neue Banner-Bestellung: ${n.step6.firmaKontakt} - ${n.step1.menge}x ${o(n.step1.rahmenart)}`,s=l(n),r=function(e,n){return`\n<!DOCTYPE html>\n<html>\n<head>\n  <meta charset="UTF-8">\n  <style>\n    body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }\n    .container { max-width: 600px; margin: 0 auto; padding: 20px; }\n    .header { background: linear-gradient(135deg, #3B4CC0 0%, #2A3A9F 100%); color: white; padding: 30px; text-align: center; border-radius: 8px 8px 0 0; }\n    .content { background: white; padding: 30px; border: 1px solid #e0e0e0; }\n    .box { background: #f5f7fa; padding: 20px; border-radius: 8px; margin: 20px 0; border-left: 4px solid #3B4CC0; }\n    .footer { background: #333; color: white; padding: 20px; text-align: center; border-radius: 0 0 8px 8px; }\n    .button { display: inline-block; background: #4CAF50; color: white; padding: 12px 30px; text-decoration: none; border-radius: 6px; margin: 20px 0; }\n    h2 { color: #3B4CC0; margin-top: 0; }\n  </style>\n</head>\n<body>\n  <div class="container">\n    <div class="header">\n      <h1 style="margin: 0;">‚úÖ Bestellung eingegangen!</h1>\n      <p style="margin: 10px 0 0 0; opacity: 0.9;">Vielen Dank f√ºr Ihre Anfrage</p>\n    </div>\n    \n    <div class="content">\n      <p>Sehr geehrte/r ${e.step6.ansprechpartner},</p>\n      \n      <p>vielen Dank f√ºr Ihre Banner-Bestellung bei S&S Messebau GbR!</p>\n      \n      <p>Wir haben Ihre Konfiguration erfolgreich erhalten und werden uns <strong>innerhalb von 24 Stunden</strong> mit einem individuellen Angebot bei Ihnen melden.</p>\n      \n      <div class="box">\n        <h2>üìã Ihre Bestellung im √úberblick</h2>\n        <p><strong>Bestellnummer:</strong> #${n.slice(-8)}</p>\n        <p><strong>Rahmenart:</strong> ${o(e.step1.rahmenart)}</p>\n        <p><strong>Menge:</strong> ${e.step1.menge} St√ºck</p>\n        <p><strong>Ma√üe:</strong> ${e.step2.breite} √ó ${e.step2.hoehe} mm</p>\n        ${e.step5.wunschDatum?`<p><strong>Wunschlieferung:</strong> ${new Date(e.step5.wunschDatum).toLocaleDateString("de-DE")}</p>`:""}\n      </div>\n      \n      <h2>üöÄ Wie geht es weiter?</h2>\n      <ol>\n        <li><strong>Pr√ºfung:</strong> Wir pr√ºfen Ihre Anfrage und alle Anforderungen</li>\n        <li><strong>Angebot:</strong> Sie erhalten ein detailliertes Angebot mit Festpreisen</li>\n        <li><strong>Produktion:</strong> Nach Ihrer Freigabe starten wir die Fertigung</li>\n        <li><strong>Lieferung:</strong> P√ºnktliche Lieferung zum Wunschtermin</li>\n      </ol>\n      \n      <p>Bei R√ºckfragen stehen wir Ihnen jederzeit zur Verf√ºgung!</p>\n      \n      <p style="margin-top: 30px;">\n        Mit freundlichen Gr√º√üen<br>\n        <strong>Ihr S&S Messebau Team</strong>\n      </p>\n    </div>\n    \n    <div class="footer">\n      <p style="margin: 0 0 10px 0;"><strong>S&S Messebau GbR</strong></p>\n      <p style="margin: 0; font-size: 14px; opacity: 0.9;">\n        Bonnenbroicherstra√üe 93 | 41238 M√∂nchengladbach<br>\n        Tel: +49 176 31570041<br>\n        E-Mail: sunds-messebau@gmx.de\n      </p>\n    </div>\n  </div>\n</body>\n</html>\n  `.trim()}(n,t),u=n.step4.serializedFiles&&n.step4.serializedFiles.length>0?`\n\nüìé Anh√§nge: ${n.step4.serializedFiles.length} Datei(en) (${n.step4.serializedFiles.map(e=>e.name).join(", ")})`:"",v={to:"info@sunds-messebau.de",subject:i,htmlBody:s,textBody:c(s)+u,customerEmail:n.step6.email,customerSubject:`Auftragsbest√§tigung: Banner-Bestellung #${t.slice(-8)}`,customerHtmlBody:r,customerTextBody:c(r),attachments:n.step4.serializedFiles||[],configId:t,timestamp:(new Date).toISOString(),sent:!1},p=`email_queue_${t}`;if(await window.spark.kv.set(p,v),a){const e=await d(p);return e.success?{success:!0,queueId:p}:{success:!1,queueId:p,error:e.error}}return{success:!0,queueId:p}}catch(n){console.error("‚ùå Fehler beim E-Mail-Versand:",n);return{success:!1,error:n instanceof Error?n.message:"Unbekannter Fehler"}}},sendQueuedEmail:d},Symbol.toStringTag,{value:"Module"}));export{t as a,u as e,r as g,d as s,s as t};
