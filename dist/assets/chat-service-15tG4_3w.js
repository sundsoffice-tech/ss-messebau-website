const e={maxRequests:10,windowMs:6e4,cooldownMs:3e4},t="chat_rate_limit";function s(e){try{localStorage.setItem(t,JSON.stringify(e))}catch{}}function r(r=e){const n=Date.now(),i=function(){try{const e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch{}return{timestamps:[],blockedUntil:null}}();return i.blockedUntil&&n<i.blockedUntil?{allowed:!1,remainingRequests:0,retryAfterMs:i.blockedUntil-n}:(i.blockedUntil&&n>=i.blockedUntil&&(i.blockedUntil=null),i.timestamps=i.timestamps.filter(e=>n-e<r.windowMs),i.timestamps.length>=r.maxRequests?(i.blockedUntil=n+r.cooldownMs,s(i),{allowed:!1,remainingRequests:0,retryAfterMs:r.cooldownMs}):(i.timestamps.push(n),s(i),{allowed:!0,remainingRequests:r.maxRequests-i.timestamps.length,retryAfterMs:null}))}const n=[/ignore\s+(all\s+)?previous\s+(instructions?|prompts?|rules?)/i,/forget\s+(all\s+)?previous\s+(instructions?|prompts?|context)/i,/disregard\s+(all\s+)?previous/i,/override\s+(system|instructions?)/i,/you\s+are\s+now\s+(a|an|the)\s/i,/act\s+as\s+(a|an|the)\s+(different|new)/i,/new\s+role\s*:/i,/system\s*prompt\s*:/i,/repeat\s+(the\s+)?(system\s+)?prompt/i,/show\s+(me\s+)?(the\s+)?(system\s+)?(prompt|instructions)/i,/what\s+(are|is)\s+(your|the)\s+(system\s+)?(prompt|instructions|rules)/i,/```\s*(javascript|python|bash|sh|exec|eval)/i,/<script[\s>]/i],i="chat_security_log";function a(){try{const e=localStorage.getItem(i);return e?JSON.parse(e):[]}catch{return[]}}const o="chat_audit_log";function c(e){try{const t=localStorage.getItem(o),s=t?JSON.parse(t):[];s.push(e);const r=s.slice(-200);localStorage.setItem(o,JSON.stringify(r))}catch{}}function l(){try{const e=localStorage.getItem(o);return e?JSON.parse(e):[]}catch{return[]}}async function m(e){const t=r();if(!t.allowed){const e=Math.ceil((t.retryAfterMs||3e4)/1e3);return c({timestamp:Date.now(),action:"chat_blocked",details:`Rate limit überschritten. Retry nach ${e}s`}),{success:!1,message:`Zu viele Anfragen. Bitte warten Sie ${e} Sekunden.`,error:"RATE_LIMIT",rateLimitInfo:t}}const s=function(e){if(!e||"string"!=typeof e)return{sanitized:"",blocked:!0,reason:"Leere Eingabe"};let t=e.trim();if(0===t.length)return{sanitized:"",blocked:!0,reason:"Leere Eingabe"};t.length>2e3&&(t=t.slice(0,2e3));for(const s of n)if(s.test(t))return{sanitized:"",blocked:!0,reason:"Unzulässige Eingabe erkannt"};return t=t.replace(/<[^>]*>/g,""),t=t.replace(/\s{3,}/g,"  "),{sanitized:t,blocked:!1}}(e.message);if(s.blocked)return function(e,t){try{const s=localStorage.getItem(i),r=s?JSON.parse(s):[];r.push({timestamp:Date.now(),reason:t,inputPreview:e.slice(0,100)});const n=r.slice(-100);localStorage.setItem(i,JSON.stringify(n))}catch{}}(e.message,s.reason||"blocked"),c({timestamp:Date.now(),action:"chat_blocked",details:`Eingabe blockiert: ${s.reason}`,inputPreview:e.message.slice(0,50)}),{success:!1,message:"Ihre Nachricht konnte nicht verarbeitet werden. Bitte formulieren Sie Ihre Frage neu.",error:"BLOCKED",rateLimitInfo:t};const a=await async function(){return""}(),o=e.systemPrompt+a;try{c({timestamp:Date.now(),action:"chat_request",details:"Chat-Anfrage gesendet",inputPreview:s.sanitized.slice(0,50)});const r=await fetch("/api/chat.php",{method:"POST",credentials:"include",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:s.sanitized,systemPrompt:o,context:e.context})}),n=await r.text();let i;try{i=JSON.parse(n)}catch(l){throw console.error("Failed to parse response as JSON:",n),new Error("Invalid JSON response from server")}if(!r.ok||!i.success)throw new Error(i.error||"API request failed");return{success:!0,message:i.message,rateLimitInfo:t}}catch(m){const e=m instanceof Error?m.message:"unknown";return console.error("Chat-Service Fehler:",e),c({timestamp:Date.now(),action:"chat_error",details:`LLM-Fehler: ${e.slice(0,100)}`}),{success:!1,message:"Der KI-Berater ist momentan nicht erreichbar. Bitte versuchen Sie es später erneut oder nutzen Sie unser Kontaktformular.",error:"SERVICE_ERROR",rateLimitInfo:t}}}export{a,l as g,m as s};
