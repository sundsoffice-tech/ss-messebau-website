const e={maxRequests:10,windowMs:6e4,cooldownMs:3e4},t="chat_rate_limit";function s(e){try{localStorage.setItem(t,JSON.stringify(e))}catch{}}function n(n=e){const r=Date.now(),i=function(){try{const e=localStorage.getItem(t);if(e)return JSON.parse(e)}catch{}return{timestamps:[],blockedUntil:null}}();return i.blockedUntil&&r<i.blockedUntil?{allowed:!1,remainingRequests:0,retryAfterMs:i.blockedUntil-r}:(i.blockedUntil&&r>=i.blockedUntil&&(i.blockedUntil=null),i.timestamps=i.timestamps.filter(e=>r-e<n.windowMs),i.timestamps.length>=n.maxRequests?(i.blockedUntil=r+n.cooldownMs,s(i),{allowed:!1,remainingRequests:0,retryAfterMs:n.cooldownMs}):(i.timestamps.push(r),s(i),{allowed:!0,remainingRequests:n.maxRequests-i.timestamps.length,retryAfterMs:null}))}const r=[/ignore\s+(all\s+)?previous\s+(instructions?|prompts?|rules?)/i,/forget\s+(all\s+)?previous\s+(instructions?|prompts?|context)/i,/disregard\s+(all\s+)?previous/i,/override\s+(system|instructions?)/i,/you\s+are\s+now\s+(a|an|the)\s/i,/act\s+as\s+(a|an|the)\s+(different|new)/i,/new\s+role\s*:/i,/system\s*prompt\s*:/i,/repeat\s+(the\s+)?(system\s+)?prompt/i,/show\s+(me\s+)?(the\s+)?(system\s+)?(prompt|instructions)/i,/what\s+(are|is)\s+(your|the)\s+(system\s+)?(prompt|instructions|rules)/i,/```\s*(javascript|python|bash|sh|exec|eval)/i,/<script[\s>]/i],i="chat_security_log";function a(){try{const e=localStorage.getItem(i);return e?JSON.parse(e):[]}catch{return[]}}const o="chat_audit_log";function c(e){try{const t=localStorage.getItem(o),s=t?JSON.parse(t):[];s.push(e);const n=s.slice(-200);localStorage.setItem(o,JSON.stringify(n))}catch{}}function l(){try{const e=localStorage.getItem(o);return e?JSON.parse(e):[]}catch{return[]}}async function m(e){const t=n();if(!t.allowed){const e=Math.ceil((t.retryAfterMs||3e4)/1e3);return c({timestamp:Date.now(),action:"chat_blocked",details:`Rate limit überschritten. Retry nach ${e}s`}),{success:!1,message:`Zu viele Anfragen. Bitte warten Sie ${e} Sekunden.`,error:"RATE_LIMIT",rateLimitInfo:t}}const s=function(e){if(!e||"string"!=typeof e)return{sanitized:"",blocked:!0,reason:"Leere Eingabe"};let t=e.trim();if(0===t.length)return{sanitized:"",blocked:!0,reason:"Leere Eingabe"};t.length>2e3&&(t=t.slice(0,2e3));for(const s of r)if(s.test(t))return{sanitized:"",blocked:!0,reason:"Unzulässige Eingabe erkannt"};return t=t.replace(/<[^>]*>/g,""),t=t.replace(/\s{3,}/g,"  "),{sanitized:t,blocked:!1}}(e.message);if(s.blocked)return function(e,t){try{const s=localStorage.getItem(i),n=s?JSON.parse(s):[];n.push({timestamp:Date.now(),reason:t,inputPreview:e.slice(0,100)});const r=n.slice(-100);localStorage.setItem(i,JSON.stringify(r))}catch{}}(e.message,s.reason||"blocked"),c({timestamp:Date.now(),action:"chat_blocked",details:`Eingabe blockiert: ${s.reason}`,inputPreview:e.message.slice(0,50)}),{success:!1,message:"Ihre Nachricht konnte nicht verarbeitet werden. Bitte formulieren Sie Ihre Frage neu.",error:"BLOCKED",rateLimitInfo:t};const a=await async function(){try{const e=localStorage.getItem("spark_kv_ai_training_data");if(!e)return"";const t=JSON.parse(e).filter(e=>e.active);return 0===t.length?"":"\n\nZUSÄTZLICHES WISSEN (Admin-gepflegt):\n"+t.map(e=>`[${e.title}]\n${e.content}`).join("\n\n")}catch{return""}}(),o=e.systemPrompt+a+"\n\nAKTUELLE KUNDENFRAGE:\n"+s.sanitized+"\n\nAntworte jetzt:";try{c({timestamp:Date.now(),action:"chat_request",details:"Chat-Anfrage gesendet",inputPreview:s.sanitized.slice(0,50)});return{success:!0,message:await window.spark.llm(o,"gpt-4o",!1),rateLimitInfo:t}}catch(l){const e=l instanceof Error?l.message:"unknown";return console.error("Chat-Service Fehler:",e),c({timestamp:Date.now(),action:"chat_error",details:`LLM-Fehler: ${e.slice(0,100)}`}),{success:!1,message:"Der KI-Berater ist momentan nicht erreichbar. Bitte versuchen Sie es später erneut oder nutzen Sie unser Kontaktformular.",error:"SERVICE_ERROR",rateLimitInfo:t}}}export{a,l as g,m as s};
